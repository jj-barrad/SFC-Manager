<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>SFC PP 管理アプリ（実用安定版）</title>
<style>
body { font-family:-apple-system,BlinkMacSystemFont,sans-serif; background:#f4f7fb; margin:0; padding:16px; }
h1 { text-align:center; color:#0053a0; }
.card { background:#fff; padding:14px; border-radius:12px; margin-bottom:14px; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
label { display:block; margin-top:8px; font-weight:600; }
input,select,button { width:100%; padding:8px; margin-top:4px; border-radius:8px; border:1px solid #ccc; }
.row { display:flex; gap:8px; }
.row > * { flex:1; }
button { background:#0053a0; color:white; font-weight:700; }
button.small { width:auto; padding:6px 10px; }
button.delete { background:#c9302c; }
table { width:100%; border-collapse:collapse; margin-top:8px; font-size:13px; }
th,td { padding:6px; border-bottom:1px solid #ddd; text-align:center; }
.warn { color:#b06a00; font-weight:700; }
.good { color:#0a7b3d; font-weight:700; }
.bar { height:16px; background:#0053a0; border-radius:6px; color:#fff; padding-left:6px; }
</style>
</head>
<body>

<h1>SFC PP 管理アプリ</h1>

<!-- ================== SUMMARY ================== -->
<div class="card">
<strong>合計PP:</strong> <span id="totalPP">0</span> / 50,000　
<strong>費用:</strong> <span id="totalCost">0</span>円　
<strong>PP単価:</strong> <span id="ppUnit">0</span>
<progress id="progress" max="50000" value="0" style="width:100%;margin-top:8px"></progress>
</div>

<!-- ================== PLAN MODE ================== -->
<div class="card">
<h2>旅行計画（ざっくり確認）</h2>

<div class="row">
<select id="preset">
<option value="">プリセット</option>
<option value="HND-OKA">HND → OKA</option>
<option value="HND-HNL">HND → HNL</option>
<option value="HND-CTS">HND → CTS</option>
<option value="HND-FUK">HND → FUK</option>
</select>
<select id="planClass">
<option value="S">S（75%）</option>
<option value="M">M（75%）</option>
<option value="Y">Y（100%）</option>
<option value="L">L（50%）</option>
</select>
</div>

<div class="row" style="margin-top:6px">
<input id="planCost" type="number" placeholder="想定往復金額">
<select id="planTrip">
<option value="2">往復</option>
<option value="1">片道</option>
</select>
</div>

<button style="margin-top:8px" onclick="addPlan()">計画を追加</button>
<div id="planPreview" style="margin-top:8px"></div>
</div>

<!-- ================== ROUTE MILES ================== -->
<div class="card">
<h2>路線マイル管理（ANA公式）</h2>
<table>
<thead><tr><th>出発</th><th>到着</th><th>マイル</th><th></th></tr></thead>
<tbody id="routeTable"></tbody>
</table>

<div class="row">
<input id="rDep" placeholder="HND">
<input id="rArr" placeholder="OKA">
<input id="rMiles" type="number" placeholder="984">
</div>
<button style="margin-top:6px" onclick="addRoute()">追加／更新</button>
</div>

<!-- ================== FLIGHT INPUT ================== -->
<div class="card">
<h2>確定入力（予約後）</h2>
<label>日付<input id="date" type="date"></label>

<div class="row">
<input id="dep" placeholder="出発">
<input id="arr" placeholder="到着">
</div>

<div class="row">
<input id="flightNo" placeholder="便名">
<input id="cls" placeholder="クラス">
</div>

<div class="row">
<input id="pp" type="number" placeholder="PP">
<input id="cost" type="number" placeholder="金額">
</div>

<button style="margin-top:8px" onclick="addFlight()">追加</button>
</div>

<!-- ================== LIST ================== -->
<div class="card">
<h2>フライト一覧</h2>
<table>
<thead><tr><th>日付</th><th>区間</th><th>便</th><th>PP</th><th>金額</th><th></th></tr></thead>
<tbody id="list"></tbody>
</table>
</div>

<!-- ================== SUMMARY BY ROUTE ================== -->
<div class="card">
<h2>区間別集計</h2>
<div id="summary"></div>
</div>

<script>
/* ---------- 固定設定 ---------- */
const CARD_RATE = 1.25;
const CLASS_RATE = {Y:1.0, M:0.75, S:0.75, L:0.5};

/* ---------- Route Miles（更新①） ---------- */
let routeMiles = JSON.parse(localStorage.getItem("routeMiles")) || {
  "HND-OKA":984,"HND-HNL":3850,"HND-CTS":510,"HND-FUK":567
};

function saveRoutes(){ localStorage.setItem("routeMiles",JSON.stringify(routeMiles)); }

function renderRoutes(){
  const t=document.getElementById("routeTable"); t.innerHTML="";
  Object.entries(routeMiles).forEach(([k,v])=>{
    const [d,a]=k.split("-");
    t.innerHTML+=`<tr><td>${d}</td><td>${a}</td><td>${v}</td>
    <td><button class="small delete" onclick="delRoute('${k}')">削除</button></td></tr>`;
  });
}

function addRoute(){
  const d=rDep.value.trim(), a=rArr.value.trim(), m=Number(rMiles.value);
  if(!d||!a||!m) return alert("入力不完全");
  routeMiles[`${d}-${a}`]=m; saveRoutes(); renderRoutes();
}
function delRoute(k){ delete routeMiles[k]; saveRoutes(); renderRoutes(); }

/* ---------- Data ---------- */
let flights=JSON.parse(localStorage.getItem("flights")||"[]");
let plans=JSON.parse(localStorage.getItem("plans")||"[]");

/* ---------- Plan Mode（更新②③） ---------- */
function getMiles(d,a){
  return routeMiles[`${d}-${a}`]||routeMiles[`${a}-${d}`]||null;
}

preset.onchange=()=>{
  if(!preset.value) return;
  const [d,a]=preset.value.split("-");
  const m=getMiles(d,a);
  if(!m){ planPreview.innerHTML="<span class='warn'>未登録路線</span>"; return; }
  const rate=CLASS_RATE[planClass.value];
  const pp=Math.round(m*rate*CARD_RATE*planTrip.value);
  const unit=planCost.value? (planCost.value/pp).toFixed(1):"-";
  planPreview.innerHTML=`想定PP: <b>${pp}</b> / 単価: <b>${unit}</b>`;
}

function addPlan(){
  if(!preset.value) return alert("路線選択");
  const [d,a]=preset.value.split("-");
  const m=getMiles(d,a); if(!m) return;
  const rate=CLASS_RATE[planClass.value];
  const pp=Math.round(m*rate*CARD_RATE*planTrip.value);
  plans.push({d,a,pp,cost:Number(planCost.value)||0});
  localStorage.setItem("plans",JSON.stringify(plans));
  alert("計画追加");
}

/* ---------- Flight ---------- */
function addFlight(){
  const f={date:date.value,dep:dep.value,arr:arr.value,
    flightNo:flightNo.value,pp:Number(pp.value),cost:Number(cost.value)};
  flights.push(f); localStorage.setItem("flights",JSON.stringify(flights)); render();
}

/* ---------- Render ---------- */
function render(){
  const l=document.getElementById("list"); l.innerHTML="";
  let tpp=0,tc=0;
  flights.forEach((f,i)=>{
    tpp+=f.pp; tc+=f.cost;
    l.innerHTML+=`<tr><td>${f.date}</td><td>${f.dep}→${f.arr}</td>
    <td>${f.flightNo}</td><td>${f.pp}</td><td>${f.cost}</td>
    <td><button class="small delete" onclick="delFlight(${i})">×</button></td></tr>`;
  });
  totalPP.textContent=tpp; totalCost.textContent=tc;
  ppUnit.textContent=tpp?(tc/tpp).toFixed(1):0;
  progress.value=tpp;

  const sum={}; summary.innerHTML="";
  flights.forEach(f=>{
    const k=f.dep+"→"+f.arr;
    if(!sum[k]) sum[k]={pp:0};
    sum[k].pp+=f.pp;
  });
  Object.entries(sum).forEach(([k,v])=>{
    summary.innerHTML+=`<div>${k}<div class="bar" style="width:${v.pp/500}px">${v.pp}</div></div>`;
  });
}
function delFlight(i){ flights.splice(i,1); localStorage.setItem("flights",JSON.stringify(flights)); render(); }

renderRoutes(); render();
</script>

</body>
</html>
