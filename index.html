<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SFCä¿®è¡Œç®¡ç†ã‚¢ãƒ—ãƒª Stable Core v4</title>
<style>
body{font-family:-apple-system;background:#f3f6fa;margin:0}
header{background:#003f88;color:#fff;padding:14px;text-align:center;font-weight:bold}
.container{padding:15px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
input,select,button{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
button{background:#003f88;color:#fff;font-weight:bold;border:none}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border-bottom:1px solid #eee;padding:6px;text-align:center}
.bar{background:#ddd;height:14px;border-radius:8px;margin:4px 0}
.bar-inner{background:#003f88;height:100%;border-radius:8px}
.heat-good{background:#d4edda;padding:10px;border-radius:8px}
.heat-mid{background:#fff3cd;padding:10px;border-radius:8px}
.heat-bad{background:#f8d7da;padding:10px;border-radius:8px}
.small{font-size:13px;color:#666}
.warning{color:#d9534f;font-size:12px}
</style>
</head>
<body>

<header>SFCä¿®è¡Œç®¡ç†ã‚¢ãƒ—ãƒª Stable Core v4</header>

<div class="container">

<div class="card">
<b>ç·åˆçŠ¶æ³</b><br>
äºˆå®šPPï¼š<span id="totalPP">0</span> / 50,000<br>
å®Ÿç¸¾PPï¼š<span id="actualPP">0</span><br>
å¹³å‡PPå˜ä¾¡ï¼š<span id="avgUnit">0</span><br>
é‚£è¦‡æ›ç®—ï¼š<span id="nahaEq">0</span><br>
æœ­å¹Œæ›ç®—ï¼š<span id="ctsEq">0</span>
</div>

<div class="card">
<b>è¨ˆç”»å…¥åŠ›</b>

ãƒ†ãƒ³ãƒ—ãƒ¬åŒºé–“
<select id="template"></select>

å‡ºç™ºåœ°<input id="from">
åˆ°ç€åœ°<input id="to">

ç‰‡é“/å¾€å¾©
<select id="tripType">
<option value="oneway">ç‰‡é“</option>
<option value="round">å¾€å¾©</option>
</select>

èˆªç©ºä¼šç¤¾
<select id="airline">
<option value="ANA">ANA</option>
<option value="other">ä»–ç¤¾</option>
</select>

é‹è³ƒç¨®åˆ¥
<select id="rate"></select>

å›½éš›ç·šè·é›¢ï¼ˆãƒã‚¤ãƒ«ï¼‰<input type="number" id="intlDist" placeholder="å›½å†…ç·šã¯ç©ºæ¬„">
<span id="intlWarning" class="warning"></span>

åº§å¸­
<select id="seat">
<option value="normal">æ™®é€šå¸­</option>
<option value="premium">ãƒ—ãƒ¬ãƒŸã‚¢ãƒ </option>
</select>

ä¾¡æ ¼<input type="number" id="price">
æ­ä¹—æœˆ<input id="month">

<button id="addBtn">è¿½åŠ </button>
</div>

<div class="card">
<b>è¨ˆç”»ä¸€è¦§ï¼ˆç®¡ç†ï¼‰</b>
<table>
<thead>
<tr>
<th>åŒºé–“</th><th>æœˆ</th><th>PP</th><th>ä¾¡æ ¼</th><th>æ¸ˆ</th><th>å‰Šé™¤</th>
</tr>
</thead>
<tbody id="planTable"></tbody>
</table>
</div>

<div class="card"><b>æœˆåˆ¥PP</b><div id="monthly"></div></div>
<div class="card"><b>PPå˜ä¾¡ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—</b><div id="heat"></div></div>

<div class="card">
<b>ANAã‚»ãƒ¼ãƒ«ç›®å®‰</b>
<div class="small">
1æœˆ/4æœˆ/7æœˆ/10æœˆï¼šå›½å†…ç·šã‚¿ã‚¤ãƒ ã‚»ãƒ¼ãƒ«å‚¾å‘<br>
2æœˆ/9æœˆï¼šå›½éš›ç·šã‚»ãƒ¼ãƒ«å‚¾å‘
</div>
</div>

</div>

<script>

/* =========================
   Data Module
========================= */
const DataModule = (function(){
    let plans = JSON.parse(localStorage.getItem("plans")) || [];

    function save(){
        localStorage.setItem("plans", JSON.stringify(plans));
    }

    function getAll(){ return plans; }

    function add(plan){
        plans.push(plan);
        save();
    }

    function remove(index){
        plans.splice(index,1);
        save();
    }

    function toggleDone(index, val){
        plans[index].done = val;
        save();
    }

    return { getAll, add, remove, toggleDone };
})();

/* =========================
   Logic Module
========================= */
const LogicModule = (function(){

    const airportMap = {
        "ç¾½ç”°":"HND","æˆç”°":"NRT","ä¼Šä¸¹":"ITM","é–¢ç©º":"KIX","ä¸­éƒ¨":"NGO",
        "æœ­å¹Œ":"CTS","ç¦å²¡":"FUK","é‚£è¦‡":"OKA","çŸ³å£":"ISG","é¹¿å…å³¶":"KOJ",
        "åºƒå³¶":"HIJ","ä»™å°":"SDJ","å®®å¤":"MMY"
    };

    const distance = {
        "HND-OKA":984,"HND-CTS":510,"HND-FUK":567,"HND-ISG":1224,"HND-KOJ":601,
        "ITM-OKA":739,"ITM-CTS":666,"KIX-OKA":738,"NGO-OKA":758,"FUK-OKA":537
    };

    function convert(name){
        for(let k in airportMap){
            name = name.replaceAll(k, airportMap[k]);
        }
        return name.toUpperCase();
    }

    function isDomestic(from,to){
        return distance[from+"-"+to] || distance[to+"-"+from];
    }

    function calcDomestic(from,to,rate,seat){
        let base = distance[from+"-"+to] || distance[to+"-"+from];
        let pp = base * rate + 400;
        if(seat==="premium") pp *= 1.5;
        return pp;
    }

    function calcIntl(dist,rate){
        return dist * rate;
    }

    return { convert, isDomestic, calcDomestic, calcIntl };

})();

/* =========================
   UI Module
========================= */
const UIModule = (function(){

    function init(){
        initTemplates();
        initRates();
        render();
    }

    function initTemplates(){
        const select = document.getElementById("template");
        const templates = [
            "HND-OKA","HND-CTS","HND-FUK","HND-ISG","HND-KOJ",
            "ITM-OKA","ITM-CTS","KIX-OKA","NGO-OKA","FUK-OKA"
        ];
        select.innerHTML = '<option value="">é¸æŠãªã—</option>';
        templates.forEach(t=>{
            select.innerHTML += `<option value="${t}">${t}</option>`;
        });
        select.addEventListener("change",()=>{
            let val = select.value;
            if(!val) return;
            let arr = val.split("-");
            document.getElementById("from").value = arr[0];
            document.getElementById("to").value = arr[1];
        });
    }

    function initRates(){
        const rateSelect = document.getElementById("rate");
        const rates = [
            ["0.75","ã‚¹ãƒ¼ãƒ‘ãƒ¼ãƒãƒªãƒ¥ãƒ¼(75%)"],
            ["1","ãƒãƒªãƒ¥ãƒ¼(100%)"],
            ["1.25","ãƒ—ãƒ¬ãƒŸã‚¢ãƒ æ ªä¸»(125%)"],
            ["1","å›½éš›ç·šY/B/M(100%)"],
            ["0.5","å›½éš›ç·šæ ¼å®‰(50%)"]
        ];
        rates.forEach(r=>{
            rateSelect.innerHTML += `<option value="${r[0]}">${r[1]}</option>`;
        });
    }

    function render(){
        let plans = DataModule.getAll();
        let total=0, actual=0, cost=0, monthly={};
        let tableHTML="";

        plans.forEach((p,i)=>{
            total+=p.pp;
            cost+=p.price;
            if(p.done) actual+=p.pp;
            if(p.month){
                if(!monthly[p.month]) monthly[p.month]=0;
                monthly[p.month]+=p.pp;
            }

            tableHTML+=`
            <tr>
            <td>${p.route}</td>
            <td>${p.month||""}</td>
            <td>${p.pp}</td>
            <td>${p.price||""}</td>
            <td><input type="checkbox" ${p.done?"checked":""} data-index="${i}" class="doneCheck"></td>
            <td><button data-index="${i}" class="deleteBtn">å‰Šé™¤</button></td>
            </tr>`;
        });

        document.getElementById("planTable").innerHTML=tableHTML;

        let avg = total? cost/total : 0;

        document.getElementById("totalPP").innerText=total;
        document.getElementById("actualPP").innerText=actual;
        document.getElementById("avgUnit").innerText=avg.toFixed(1);
        document.getElementById("nahaEq").innerText=(total/2276).toFixed(1);
        document.getElementById("ctsEq").innerText=(total/1365).toFixed(1);

        renderMonthly(monthly);
        renderHeat(avg);

        attachEvents();
    }

    function renderMonthly(monthly){
        let html="";
        for(let m in monthly){
            let width=Math.min(monthly[m]/500,100);
            html+=`${m}<div class="bar"><div class="bar-inner" style="width:${width}%"></div></div>`;
        }
        document.getElementById("monthly").innerHTML=html;
    }

    function renderHeat(avg){
        let cls="heat-good";
        if(avg>15) cls="heat-bad";
        else if(avg>13) cls="heat-mid";
        document.getElementById("heat").innerHTML=`<div class="${cls}">å¹³å‡å˜ä¾¡ ${avg.toFixed(1)} å††</div>`;
    }

    function attachEvents(){
        document.querySelectorAll(".doneCheck").forEach(cb=>{
            cb.onclick = ()=> {
                DataModule.toggleDone(cb.dataset.index, cb.checked);
                render();
            };
        });

        document.querySelectorAll(".deleteBtn").forEach(btn=>{
            btn.onclick = ()=>{
                DataModule.remove(btn.dataset.index);
                render();
            };
        });
    }

    return { init, render };

})();

/* =========================
   Input Module
========================= */
const InputModule = (function(){

    function add(){
        let from = LogicModule.convert(document.getElementById("from").value);
        let to = LogicModule.convert(document.getElementById("to").value);
        let type = document.getElementById("tripType").value;
        let airline = document.getElementById("airline").value;
        let rate = parseFloat(document.getElementById("rate").value);
        let seat = document.getElementById("seat").value;
        let price = parseFloat(document.getElementById("price").value)||0;
        let month = document.getElementById("month").value;
        let intl = parseFloat(document.getElementById("intlDist").value);

        let pp=0;
        let route=from+"-"+to;

        if(airline==="ANA"){
            if(LogicModule.isDomestic(from,to)){
                pp+=LogicModule.calcDomestic(from,to,rate,seat);
                if(type==="round") pp+=LogicModule.calcDomestic(to,from,rate,seat);
                document.getElementById("intlWarning").innerText="";
            }else{
                if(!intl){
                    document.getElementById("intlWarning").innerText="â€»å›½éš›ç·šã¯è·é›¢å…¥åŠ›å¿…é ˆ";
                    return;
                }
                pp+=LogicModule.calcIntl(intl,rate);
                if(type==="round") pp+=LogicModule.calcIntl(intl,rate);
            }
        }

        pp=Math.floor(pp);

        DataModule.add({route,pp,price,month,done:false});
        UIModule.render();
    }

    return { add };

})();

/* =========================
   Bootstrap
========================= */
document.getElementById("addBtn").addEventListener("click", InputModule.add);
UIModule.init();

/* ==============================
   Unified Strategy Engine v1
   Strategy + Ultimate å®Œå…¨çµ±åˆ
   Phase2å«ã‚€
================================ */

const StrategyEngine = (function(){

    function collect(){
        const plans = DataModule.getAll();
        let totalPP=0, actualPP=0, totalCost=0;
        let monthly={}, routeStats={};

        plans.forEach(p=>{
            totalPP+=p.pp;
            totalCost+=p.price;
            if(p.done) actualPP+=p.pp;

            if(p.month){
                if(!monthly[p.month]) monthly[p.month]=0;
                monthly[p.month]+=p.pp;
            }

            if(!routeStats[p.route]) routeStats[p.route]={pp:0,cost:0,count:0};
            routeStats[p.route].pp+=p.pp;
            routeStats[p.route].cost+=p.price;
            routeStats[p.route].count++;
        });

        return {plans,totalPP,actualPP,totalCost,monthly,routeStats};
    }

    function render(){

        const d = collect();
        const remain = 50000 - d.actualPP;
        const avgUnit = d.totalPP ? d.totalCost/d.totalPP : 0;
        const monthsUsed = Object.keys(d.monthly).length;
        const remainMonths = Math.max(1,12-monthsUsed);
        const perMonth = Math.ceil(remain/remainMonths);
        const projectedCost = remain * (avgUnit||12);

        let bestRoute=null, bestUnit=999;
        for(let r in d.routeStats){
            const u=d.routeStats[r].cost/d.routeStats[r].pp;
            if(u<bestUnit){ bestUnit=u; bestRoute=r; }
        }

        const progressPercent = Math.min(100, (d.actualPP/50000)*100);

        let score=100;
        if(avgUnit>15) score-=30;
        else if(avgUnit>13) score-=15;
        if(remain>30000) score-=10;
        if(score<0) score=0;

        let html="";

        html+=`<b>ğŸ¯ ä¿®è¡Œãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—</b><br>`;
        if(remain<=0){
            html+=`ãƒ€ã‚¤ãƒ¤é”æˆæ¸ˆã¿<br><br>`;
        }else{
            html+=`æ®‹ ${remain} PP<br>`;
            html+=`æœˆå¹³å‡ ${perMonth} PP å¿…è¦<br><br>`;
        }

        html+=`<b>ğŸ“Š é€²æ—ãƒãƒ¼</b><br>`;
        html+=`
        <div style="background:#eee;border-radius:8px;">
            <div style="width:${progressPercent}%;background:#2a6df4;height:18px;border-radius:8px;"></div>
        </div>
        ${Math.floor(progressPercent)}%é”æˆ<br><br>
        `;

        html+=`<b>ğŸ§  åŠ¹ç‡ã‚¹ã‚³ã‚¢</b><br>${score}/100<br><br>`;

        html+=`<b>ğŸ’° äºˆæ¸¬æ®‹äºˆç®—</b><br>${Math.floor(projectedCost).toLocaleString()}å††<br><br>`;

        if(bestRoute){
            html+=`<b>ğŸ§­ æœ€é©ãƒ«ãƒ¼ãƒˆ</b><br>${bestRoute} (${bestUnit.toFixed(1)}å††/PP)<br><br>`;
        }

        html+=`<b>âš  ãƒªã‚¹ã‚¯åˆ†æ</b><br>`;
        if(remain>40000) html+=`ä¿®è¡Œæœªç€æ‰‹ã«è¿‘ã„çŠ¶æ…‹<br>`;
        if(avgUnit>15) html+=`å˜ä¾¡é«˜ã‚<br>`;
        if(remainMonths<3 && remain>10000) html+=`æ®‹æœŸé–“ä¸è¶³ãƒªã‚¹ã‚¯<br>`;

        document.getElementById("strategyUnified").innerHTML=html;
    }

    return {render};
})();

(function(){
    const container=document.querySelector(".container");
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<div id="strategyUnified"></div>`;
    container.appendChild(card);

    const originalRender=UIModule.render;
    UIModule.render=function(){
        originalRender();
        StrategyEngine.render();
    };

    StrategyEngine.render();
})();
/* ==============================
   Route Optimization Engine v1
================================ */

const OptimizationEngine = (function(){

    function analyze(){
        const plans = DataModule.getAll();
        let actualPP=0;
        let routeStats={};

        plans.forEach(p=>{
            if(p.done) actualPP+=p.pp;

            if(!routeStats[p.route]) routeStats[p.route]={pp:0,cost:0,count:0};
            routeStats[p.route].pp+=p.pp;
            routeStats[p.route].cost+=p.price;
            routeStats[p.route].count++;
        });

        const remain=50000-actualPP;

        let bestRoute=null;
        let bestUnit=999;
        let avgPPperTrip=0;

        for(let r in routeStats){
            const unit=routeStats[r].cost/routeStats[r].pp;
            if(unit<bestUnit){
                bestUnit=unit;
                bestRoute=r;
                avgPPperTrip=routeStats[r].pp/routeStats[r].count;
            }
        }

        if(!bestRoute){
            return null;
        }

        const tripsNeeded=Math.ceil(remain/avgPPperTrip);
        const estimatedCost=Math.floor(tripsNeeded*avgPPperTrip*bestUnit);

        return {remain,bestRoute,tripsNeeded,estimatedCost,bestUnit};
    }

    function render(){
        const result=analyze();

        if(!result) return;

        let html="";

        html+=`<b>ğŸ¤– è‡ªå‹•æœ€é©ä¿®è¡Œãƒ—ãƒ©ãƒ³</b><br>`;
        html+=`æ®‹ ${result.remain}PP<br>`;
        html+=`æ¨å¥¨è·¯ç·šï¼š${result.bestRoute}<br>`;
        html+=`å¿…è¦å¾€å¾©å›æ•°ï¼šç´„ ${result.tripsNeeded} å›<br>`;
        html+=`æƒ³å®šè¿½åŠ äºˆç®—ï¼šç´„ ${result.estimatedCost.toLocaleString()} å††<br>`;
        html+=`æƒ³å®šå˜ä¾¡ï¼š${result.bestUnit.toFixed(1)} å††/PP`;

        document.getElementById("optimizePanel").innerHTML=html;
    }

    return {render};
})();

(function(){
    const container=document.querySelector(".container");
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<div id="optimizePanel"></div>`;
    container.appendChild(card);

    const originalRender=UIModule.render;
    UIModule.render=function(){
        originalRender();
        StrategyEngine.render();
        OptimizationEngine.render();
    };

    OptimizationEngine.render();
})();
/* ==============================
   International Hybrid Optimizer
================================ */

const HybridOptimizer = (function(){

    const intlOptions = [
        {route:"HND-HNL", pp:8000, cost:120000},
        {route:"HND-SIN", pp:6000, cost:90000},
        {route:"HND-BKK", pp:5500, cost:85000},
        {route:"HND-ICN", pp:2000, cost:40000},
        {route:"HND-TPE", pp:3000, cost:55000}
    ];

    function analyze(){
        const plans = DataModule.getAll();

        let actualPP=0;
        let domesticBest=null;
        let bestDomesticUnit=999;
        let avgPPperTrip=0;

        let routeStats={};

        plans.forEach(p=>{
            if(p.done) actualPP+=p.pp;

            if(!routeStats[p.route]) routeStats[p.route]={pp:0,cost:0,count:0};
            routeStats[p.route].pp+=p.pp;
            routeStats[p.route].cost+=p.price;
            routeStats[p.route].count++;
        });

        for(let r in routeStats){
            const unit=routeStats[r].cost/routeStats[r].pp;
            if(unit<bestDomesticUnit){
                bestDomesticUnit=unit;
                domesticBest=r;
                avgPPperTrip=routeStats[r].pp/routeStats[r].count;
            }
        }

        const remain=50000-actualPP;

        // å›½éš›ç·šãƒ™ã‚¹ãƒˆ
        let bestIntl=null;
        let bestIntlUnit=999;

        intlOptions.forEach(opt=>{
            const unit=opt.cost/opt.pp;
            if(unit<bestIntlUnit){
                bestIntlUnit=unit;
                bestIntl=opt;
            }
        });

        if(!domesticBest){
            return null;
        }

        // æ··åˆæ¡ˆï¼ˆä¾‹ï¼šå›½éš›1å›ï¼‹å›½å†…è£œå¡«ï¼‰
        const intlTrips=1;
        const remainAfterIntl=remain-bestIntl.pp;

        const domesticTrips=Math.ceil(remainAfterIntl/avgPPperTrip);

        const totalCost=
            bestIntl.cost +
            domesticTrips*avgPPperTrip*bestDomesticUnit;

        return {
            remain,
            domesticBest,
            bestDomesticUnit,
            bestIntl,
            domesticTrips,
            totalCost
        };
    }

    function render(){
        const r=analyze();
        if(!r) return;

        let html="";
        html+=`<b>ğŸŒ å›½éš›ç·šæ··åˆæœ€é©åŒ–</b><br>`;
        html+=`æ¨å¥¨ï¼š${r.bestIntl.route} 1å› + ${r.domesticBest} ${r.domesticTrips}å›<br>`;
        html+=`æƒ³å®šç·è¿½åŠ äºˆç®—ï¼šç´„ ${Math.floor(r.totalCost).toLocaleString()} å††<br>`;
        html+=`å›½å†…å˜ä¾¡ï¼š${r.bestDomesticUnit.toFixed(1)} å††/PP`;

        document.getElementById("hybridPanel").innerHTML=html;
    }

    return {render};
})();

(function(){
    const container=document.querySelector(".container");
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`<div id="hybridPanel"></div>`;
    container.appendChild(card);

    const originalRender=UIModule.render;
    UIModule.render=function(){
        originalRender();
        StrategyEngine.render();
        OptimizationEngine.render();
        HybridOptimizer.render();
    };

    HybridOptimizer.render();
})();
</script>

</body>
</html>