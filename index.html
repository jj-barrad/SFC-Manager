<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>SFC修行管理アプリ Stable Core v4</title>
<style>
body{font-family:-apple-system;background:#f3f6fa;margin:0}
header{background:#003f88;color:#fff;padding:14px;text-align:center;font-weight:bold}
.container{padding:15px}
.card{background:#fff;border-radius:14px;padding:14px;margin-bottom:14px;box-shadow:0 4px 12px rgba(0,0,0,0.08)}
input,select,button{width:100%;padding:8px;margin:6px 0;border-radius:8px;border:1px solid #ccc}
button{background:#003f88;color:#fff;font-weight:bold;border:none}
table{width:100%;border-collapse:collapse;font-size:12px}
th,td{border-bottom:1px solid #eee;padding:6px;text-align:center}
.bar{background:#ddd;height:14px;border-radius:8px;margin:4px 0}
.bar-inner{background:#003f88;height:100%;border-radius:8px}
.heat-good{background:#d4edda;padding:10px;border-radius:8px}
.heat-mid{background:#fff3cd;padding:10px;border-radius:8px}
.heat-bad{background:#f8d7da;padding:10px;border-radius:8px}
.small{font-size:13px;color:#666}
.warning{color:#d9534f;font-size:12px}
</style>
</head>
<body>

<header>SFC修行管理アプリ Stable Core v4</header>

<div class="container">

<div class="card">
<b>総合状況</b><br>
予定PP：<span id="totalPP">0</span> / 50,000<br>
実績PP：<span id="actualPP">0</span><br>
平均PP単価：<span id="avgUnit">0</span><br>
那覇換算：<span id="nahaEq">0</span><br>
札幌換算：<span id="ctsEq">0</span>
</div>

<div class="card">
<b>計画入力</b>

テンプレ区間
<select id="template"></select>

出発地<input id="from">
到着地<input id="to">

片道/往復
<select id="tripType">
<option value="oneway">片道</option>
<option value="round">往復</option>
</select>

航空会社
<select id="airline">
<option value="ANA">ANA</option>
<option value="other">他社</option>
</select>

運賃種別
<select id="rate"></select>

国際線距離（マイル）<input type="number" id="intlDist" placeholder="国内線は空欄">
<span id="intlWarning" class="warning"></span>

座席
<select id="seat">
<option value="normal">普通席</option>
<option value="premium">プレミアム</option>
</select>

価格<input type="number" id="price">
搭乗月<input id="month">

<button id="addBtn">追加</button>
</div>

<div class="card">
<b>計画一覧（管理）</b>
<table>
<thead>
<tr>
<th>区間</th><th>月</th><th>PP</th><th>価格</th><th>済</th><th>削除</th>
</tr>
</thead>
<tbody id="planTable"></tbody>
</table>
</div>

<div class="card"><b>月別PP</b><div id="monthly"></div></div>
<div class="card"><b>PP単価ヒートマップ</b><div id="heat"></div></div>

<div class="card">
<b>ANAセール目安</b>
<div class="small">
1月/4月/7月/10月：国内線タイムセール傾向<br>
2月/9月：国際線セール傾向
</div>
</div>

</div>

<script>

/* =========================
   Data Module
========================= */
const DataModule = (function(){
    let plans = JSON.parse(localStorage.getItem("plans")) || [];

    function save(){
        localStorage.setItem("plans", JSON.stringify(plans));
    }

    function getAll(){ return plans; }

    function add(plan){
        plans.push(plan);
        save();
    }

    function remove(index){
        plans.splice(index,1);
        save();
    }

    function toggleDone(index, val){
        plans[index].done = val;
        save();
    }

    return { getAll, add, remove, toggleDone };
})();

/* =========================
   Logic Module
========================= */
const LogicModule = (function(){

    const airportMap = {
        "羽田":"HND","成田":"NRT","伊丹":"ITM","関空":"KIX","中部":"NGO",
        "札幌":"CTS","福岡":"FUK","那覇":"OKA","石垣":"ISG","鹿児島":"KOJ",
        "広島":"HIJ","仙台":"SDJ","宮古":"MMY"
    };

    const distance = {
        "HND-OKA":984,"HND-CTS":510,"HND-FUK":567,"HND-ISG":1224,"HND-KOJ":601,
        "ITM-OKA":739,"ITM-CTS":666,"KIX-OKA":738,"NGO-OKA":758,"FUK-OKA":537
    };

    function convert(name){
        for(let k in airportMap){
            name = name.replaceAll(k, airportMap[k]);
        }
        return name.toUpperCase();
    }

    function isDomestic(from,to){
        return distance[from+"-"+to] || distance[to+"-"+from];
    }

    function calcDomestic(from,to,rate,seat){
        let base = distance[from+"-"+to] || distance[to+"-"+from];
        let pp = base * rate + 400;
        if(seat==="premium") pp *= 1.5;
        return pp;
    }

    function calcIntl(dist,rate){
        return dist * rate;
    }

    return { convert, isDomestic, calcDomestic, calcIntl };

})();

/* =========================
   UI Module
========================= */
const UIModule = (function(){

    function init(){
        initTemplates();
        initRates();
        render();
    }

    function initTemplates(){
        const select = document.getElementById("template");
        const templates = [
            "HND-OKA","HND-CTS","HND-FUK","HND-ISG","HND-KOJ",
            "ITM-OKA","ITM-CTS","KIX-OKA","NGO-OKA","FUK-OKA"
        ];
        select.innerHTML = '<option value="">選択なし</option>';
        templates.forEach(t=>{
            select.innerHTML += `<option value="${t}">${t}</option>`;
        });
        select.addEventListener("change",()=>{
            let val = select.value;
            if(!val) return;
            let arr = val.split("-");
            document.getElementById("from").value = arr[0];
            document.getElementById("to").value = arr[1];
        });
    }

    function initRates(){
        const rateSelect = document.getElementById("rate");
        const rates = [
            ["0.75","スーパーバリュー(75%)"],
            ["1","バリュー(100%)"],
            ["1.25","プレミアム株主(125%)"],
            ["1","国際線Y/B/M(100%)"],
            ["0.5","国際線格安(50%)"]
        ];
        rates.forEach(r=>{
            rateSelect.innerHTML += `<option value="${r[0]}">${r[1]}</option>`;
        });
    }

    function render(){
        let plans = DataModule.getAll();
        let total=0, actual=0, cost=0, monthly={};
        let tableHTML="";

        plans.forEach((p,i)=>{
            total+=p.pp;
            cost+=p.price;
            if(p.done) actual+=p.pp;
            if(p.month){
                if(!monthly[p.month]) monthly[p.month]=0;
                monthly[p.month]+=p.pp;
            }

            tableHTML+=`
            <tr>
            <td>${p.route}</td>
            <td>${p.month||""}</td>
            <td>${p.pp}</td>
            <td>${p.price||""}</td>
            <td><input type="checkbox" ${p.done?"checked":""} data-index="${i}" class="doneCheck"></td>
            <td><button data-index="${i}" class="deleteBtn">削除</button></td>
            </tr>`;
        });

        document.getElementById("planTable").innerHTML=tableHTML;

        let avg = total? cost/total : 0;

        document.getElementById("totalPP").innerText=total;
        document.getElementById("actualPP").innerText=actual;
        document.getElementById("avgUnit").innerText=avg.toFixed(1);
        document.getElementById("nahaEq").innerText=(total/2276).toFixed(1);
        document.getElementById("ctsEq").innerText=(total/1365).toFixed(1);

        renderMonthly(monthly);
        renderHeat(avg);

        attachEvents();
    }

    function renderMonthly(monthly){
        let html="";
        for(let m in monthly){
            let width=Math.min(monthly[m]/500,100);
            html+=`${m}<div class="bar"><div class="bar-inner" style="width:${width}%"></div></div>`;
        }
        document.getElementById("monthly").innerHTML=html;
    }

    function renderHeat(avg){
        let cls="heat-good";
        if(avg>15) cls="heat-bad";
        else if(avg>13) cls="heat-mid";
        document.getElementById("heat").innerHTML=`<div class="${cls}">平均単価 ${avg.toFixed(1)} 円</div>`;
    }

    function attachEvents(){
        document.querySelectorAll(".doneCheck").forEach(cb=>{
            cb.onclick = ()=> {
                DataModule.toggleDone(cb.dataset.index, cb.checked);
                render();
            };
        });

        document.querySelectorAll(".deleteBtn").forEach(btn=>{
            btn.onclick = ()=>{
                DataModule.remove(btn.dataset.index);
                render();
            };
        });
    }

    return { init, render };

})();

/* =========================
   Input Module
========================= */
const InputModule = (function(){

    function add(){
        let from = LogicModule.convert(document.getElementById("from").value);
        let to = LogicModule.convert(document.getElementById("to").value);
        let type = document.getElementById("tripType").value;
        let airline = document.getElementById("airline").value;
        let rate = parseFloat(document.getElementById("rate").value);
        let seat = document.getElementById("seat").value;
        let price = parseFloat(document.getElementById("price").value)||0;
        let month = document.getElementById("month").value;
        let intl = parseFloat(document.getElementById("intlDist").value);

        let pp=0;
        let route=from+"-"+to;

        if(airline==="ANA"){
            if(LogicModule.isDomestic(from,to)){
                pp+=LogicModule.calcDomestic(from,to,rate,seat);
                if(type==="round") pp+=LogicModule.calcDomestic(to,from,rate,seat);
                document.getElementById("intlWarning").innerText="";
            }else{
                if(!intl){
                    document.getElementById("intlWarning").innerText="※国際線は距離入力必須";
                    return;
                }
                pp+=LogicModule.calcIntl(intl,rate);
                if(type==="round") pp+=LogicModule.calcIntl(intl,rate);
            }
        }

        pp=Math.floor(pp);

        DataModule.add({route,pp,price,month,done:false});
        UIModule.render();
    }

    return { add };

})();

/* =========================
   Bootstrap
========================= */
document.getElementById("addBtn").addEventListener("click", InputModule.add);
UIModule.init();

</script>

</body>
</html>